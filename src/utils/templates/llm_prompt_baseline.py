#!/usr/bin/env python
# -*- coding: utf-8 -*-
# @Time    : 2025/11/1 20:36
# @Author  : lizimo@nuist.edu.cn
# @File    : llm_prompt.py
# @Description:


BASELINE_TEMP: str = """
你是一名专业的临床药师，负责根据患者病历信息分析出院携带药物方案。你必须严格遵循预设药物列表，确保所有推荐药物都在许可范围内。
-预设药物列表-
{pre_drug_list}

-目标-
给定患者的"性别、出生日期、民族、BMI、就诊时间、诊疗过程描述、入院情况、现病史、既往史、主诉、出院诊断"信息，对这些信息进行详细的分析，最终给出该患者出院所有可能应该携带药物的列表

-步骤-
1. 依据患者性别、年龄、BMI、以及临床信息来分析患者的核心健康问题

2. 基于步骤1识别的核心问题，从预设药物列表中选择合适的出院药物，将每个推荐的药物格式化为("drug"{tuple_delimiter}"你推荐的药物")

3. 以中文返回步骤2中识别出的所有推荐药物的输出列表。使用**{record_delimiter}**作为列表分隔符。

4. 完成后，输出{completion_delimiter}

################
-示例-
################
-示例 1-
输入：
################
【基本信息】
- 性别：女
- 出生日期：1957-06
- 民族：汉族
- BMI：22.9
- 就诊时间：2020-08
【临床信息】
- 诊疗过程描述：入院后完善相关检查：3.0MRI(神经组):颅脑(平扫,平扫动脉血管成像)：脑白质轻度脱髓鞘改变；左侧上颌窦炎；右侧胚胎型大脑后动脉；余颅脑MRA未见明显异常征象；随诊。3.0MRI(神经组):垂体pituitary gland(增强扫描)：垂体平扫、增强未见确切异常征象，随诊。TCD未见异常。颈部血管彩超未见异常。目前颅脑病变所致头痛、头晕依据不足。发泡试验阴性，可除外卵圆孔未闭所致头痛。动态血压示：昼夜血压平均值为148/93mmHg，日间血压平均值为146/94mmHg，夜间血压平均值为152/88mmHg，昼夜生理节律消失。目前考虑高血压所致头痛。治疗上，调整治疗方案，因患者CCB类出现腿肿，故予奥美沙坦20mg bid、美托洛尔缓释片47.5mg控制血压，目前血压控制理想，无头痛发作。针对患者走路不稳，建议完善眼科检查，指导治疗。余结果回报： 心脏+组织多普勒：二尖瓣后叶瓣环钙化；静息状态下左心整体收缩功能良好，舒张功能良好；随诊。甲状腺及淋巴结彩超：双叶甲状腺未见异常；随诊。64层CT(胸组):胸部(平扫,薄扫)：双肺结节，随诊；双肺多发钙化灶；肝右叶低密度灶，请结合其它检查。肝胆脾胰彩超：肝内实性占位病变（血管瘤可能性大）；   肝囊肿；右肾囊肿；随诊。甲状腺过氧化物酶抗体 271.62 U/ml。BNP、心肌标志物测定、D-二聚体、超敏C反应蛋白、血凝常规、电解质、肝生化+心肌酶谱、肾功、血脂、血糖(空腹)、糖化血红蛋白、游离T4、游离T3、甲状腺球蛋白抗体、高敏促甲状腺激素、尿常规+尿沉渣定量。DR骨组:单手指(正侧位),腕骨(左正侧位)：左腕关节组成骨骨质疏松改变；左桡骨远端小的骨质密度灶，考虑籽骨可能，撕脱骨折待除外；左小指骨未见明确异常改变；随诊。请手足外科会诊，建议行手腕重建CT，结果待回报。患者目前病情平稳，可以出院。
- 入院情况：患者5年前开始出现血压升高，多次测血压高于140/90mmHg，情绪变化时加重，血压最高可达160/100mmHg，时伴头晕、头痛，无视物模糊及视物旋转，走路偏斜。平素口服美托洛尔50mg每晚1次、硝苯地平缓释片30mg控制血压，血压控制尚可，但出现水肿，故半个月前停用硝苯地平缓释片，加用替米沙坦40mg每天1次，近1周血压较前明显升高，达150/90mmHg，头晕、头痛再发加重，走路歪斜，曾摔倒，无意识丧失，今晨加重，遂于我院急诊就诊，现为求进一步系统诊治来我科。
- 现病史：患者5年前开始出现血压升高，多次测血压高于140/90mmHg，情绪变化时加重，血压最高可达160/100mmHg，时伴头晕、头痛，无视物模糊及视物旋转，走路偏斜。平素口服美托洛尔50mg每晚1次、硝苯地平缓释片30mg控制血压，血压控制尚可，但出现水肿，故半个月前停用硝苯地平缓释片，加用替米沙坦40mg每天1次，近1周血压较前明显升高，达150/90mmHg，头晕、头痛再发加重，走路歪斜，曾摔倒，无意识丧失，今晨加重，遂于我院急诊就诊，现为求进一步系统诊治来我科。病来无发热，无咳嗽、咳痰，无腹痛、腹泻，饮食可，平素睡眠差，服用褪黑素辅助睡眠，近期睡眠可，近1个月无明显体重变化。
- 既往史：既往体质良好，原发性血小板增多症病史16年，每周二、周五规律予α-2b干扰素控制；甲减病史5年，平素口服优甲乐控制；曾考虑药物性肝损害，应用异甘草酸镁血压显著升高；自诉有垂体瘤病史，未治疗，否认外伤史，否认“肝炎、结核”等病史，12余年前因左肾囊肿行左肾摘除术；4年前于外院行气管异物切除术，否认输血史及血液制品使用史，对青霉素、链霉素过敏，日光、海鲜过敏，否认其他食物过敏史,否认预防接种史。
- 主诉：发现血压升高伴头晕、头痛5年，再发加重1周。
- 出院诊断：["高血压病2级 高危", "左桡骨远端撕脱骨折待除外", "原发性血小板增多症", "甲状腺功能减低症", "肝血管瘤可能性大", "肝囊肿", "右肾囊肿"]
################
输出：
("drug"{tuple_delimiter}"氯吡格雷"){record_delimiter}
("drug"{tuple_delimiter}"美托洛尔缓释片"){record_delimiter}
("drug"{tuple_delimiter}"奥美沙坦"){record_delimiter}
("drug"{tuple_delimiter}"左甲状腺素钠片"){record_delimiter}
("drug"{tuple_delimiter}"养心氏片"){record_delimiter}
{completion_delimiter}

-示例 2-
输入：
################
【基本信息】
- 性别：男
- 出生日期：1969-02
- 民族：汉族
- BMI：23.7
- 就诊时间：2019-04
【临床信息】
- 诊疗过程描述：入院后完善相关检查，各项检查结果回报示：糖化血红蛋白：糖化血红蛋白 9.70 %。胰岛素：胰岛素 8.60 mU/L，血糖(空腹)：葡萄糖 15.21 mmol/L，C肽：C肽 1.86 ng/ml。胰岛素(1h)：胰岛素 17.54 mU/L，血糖(1h)：葡萄糖 18.21 mmol/L，C肽(1h)：C肽 2.20 ng/ml。胰岛素(2h)：胰岛素 20.55 mU/L，血糖(2h)：葡萄糖 22.37 mmol/L，C肽(2h)：C肽 2.91 ng/ml。2019-04-29 胰岛素样生长因子-1及结合蛋白：胰岛素样生长因子-1 270.00 ng/ml、胰岛素样生长因子结合蛋白-3 5.98 ug/ml，胰岛素相关抗体测定：抗人胰岛素抗体 4.93 IU/ml、谷氨酸脱羧酶抗体 1.77 IU/ml。尿常规+尿沉渣定量(病房)：葡萄糖. +++ mmol/l、维生素C + g/l、细菌 98.34 /uL。尿微量白蛋白(24h)：尿微量白蛋白 16.61 mg/L、24h尿微量白蛋白 28.57 mg/24h，尿蛋白定量(24h尿)：尿蛋白定量 18.01 mg/L、24h尿蛋白定量 30.98 mg/24h、尿量 1.72 L。眼科诊断：1.双眼屈光不正 2.双眼底动脉硬化。治疗：1.严格控制内科病 2.每半年定期眼科复查。股动脉,腘动脉：双侧股、腘动脉未见异常。股静脉,腘静脉：左右股、腘静脉未见异常，随诊。颈部血管(颈动脉,椎动脉)彩超：双颈动脉未见异常，双椎动脉未见异常，随诊。治疗上予胰岛素泵降糖。余检查：病毒标志物全项：抗乙型肝炎病毒核心抗体 0.007 COI。血脂：甘油三脂 2.68 mmol/L、高密度脂蛋白胆固醇 0.86 mmol/L。性激素6项：促黄体素 7.66 mIU/ml、卵泡刺激素 10.38 mIU/ml、泌乳素 197.19 μIU/ml、睾酮 3.71 ng/ml、雌二醇 37.27 ng/L、孕酮 0.56 ng/ml。2019-04-29 电解质：钙 2.74 mmol/L。促肾上腺皮质激素测定(8:00)：促肾上腺皮质激素 21.840 pg/ml。皮质醇(8:00)：皮质醇 362.06 nmol/L。肿瘤相关抗原检测、甲状腺功能及相关抗体、肝肾功、血常规、BNP、血凝常规、心肌标志物、胰腺功能等未见明显异常。64层CT(胸组):胸部(平扫,薄扫)：双肺下叶少许炎症；右肺中叶索条灶；双肺结节，随诊；纵隔钙化淋巴结。肝胆脾胰彩超：脂肪肝（轻度），胆囊壁胆固醇结晶，胆囊息肉，随诊。甲状腺及淋巴结彩超：左叶甲状腺实性结节，随诊。泌尿系+残余尿量测定：前列腺增大，残尿约0ml，随诊。心脏彩超（含左心功能）：心脏内部结构及血流未见异常，心功能良好，随诊。目前患者病情好转，预约出院。
- 入院情况：患者4年前无意间测血糖示：17mmol/L,无明显口干、多饮、多尿，每日饮水约1000ml，尿量与饮水量相当，无明显视物模糊，无四肢麻木。遂就诊于外院住院，予诊断为2型糖尿病，予二甲双胍及胰岛素（具体不详）等降糖治疗后好转出院。患者现应用门冬30胰岛素早晚各15U降糖治疗，患者未系统监测血糖。2年前患者出现下肢麻木，1周前患者感视物模糊，监测餐前血糖16mmol/L,餐后血糖不详，患者血糖控制不佳，近为求进一步诊治就诊于我院。门诊以“糖尿病”为诊断收入院。患者病来无发热，无头晕、周身乏力，无咳嗽、咳痰，无恶心、呕吐，无胸闷、气短，无胸痛，无反酸、嗳气，无腹痛、腹泻，无尿频、尿急、尿痛，大便如常，近期体重未见明显变化。
- 现病史：患者4年前无意间测血糖示：17mmol/L,无明显口干、多饮、多尿，每日饮水约1000ml，尿量与饮水量相当，无明显视物模糊，无四肢麻木。遂就诊于外院住院，予诊断为2型糖尿病，予二甲双胍及胰岛素（具体不详）等降糖治疗后好转出院。患者现应用门冬30胰岛素早晚各15U降糖治疗，患者未系统监测血糖。2年前患者出现下肢麻木，1周前患者感视物模糊，监测餐前血糖16mmol/L,餐后血糖不详，患者血糖控制不佳，近为求进一步诊治就诊于我院。门诊以“糖尿病”为诊断收入院。患者病来无发热，无头晕、周身乏力，无咳嗽、咳痰，无恶心、呕吐，无胸闷、气短，无胸痛，无反酸、嗳气，无腹痛、腹泻，无尿频、尿急、尿痛，大便如常，近期体重未见明显变化。
- 既往史：既往体质良好，否认其它疾病史，否认外伤史，否认“肝炎、结核”等病史，否认手术史，否认输血史及血液制品使用史，否认药物及食物过敏史、中毒史,否认预防接种史。
- 主诉：发现血糖升高4年，下肢麻木2年，血糖控制不佳伴视物模糊1周。
- 出院诊断：["2型糖尿病 糖尿病周围神经病变", "双眼屈光不正  双眼底动脉硬化", "高脂血症", "双肺结节", "脂肪肝 胆囊息肉", "甲状腺结节", "前列腺增大"]
################
输出：
("drug"{tuple_delimiter}"二甲双胍"){record_delimiter}
("drug"{tuple_delimiter}"阿卡波糖"){record_delimiter}
("drug"{tuple_delimiter}"甘精胰岛素"){record_delimiter}
("drug"{tuple_delimiter}"格列齐特缓释片"){record_delimiter}
{completion_delimiter}

-真实数据-
【基本信息】
- 性别：{sex}
- 出生日期：{birth_date}
- 民族：{ethnicity}
- BMI：{bmi}
- 就诊时间：{visit_date}
【临床信息】
- 诊疗过程描述：{diagnosis_process}
- 入院情况：{admission_info}
- 现病史：{current_history}
- 既往史：{past_history}
- 主诉：{chief_complaint}
- 出院诊断：{discharge_diagnosis}
"""

IF_LOOP: str = """
看起来可能仍然遗漏了一些药物。如果仍有推荐的药物需要添加，请回答YES | NO。
"""
CONTINUE: str = """很多需要推荐的药物在上一次的提取中可能被遗漏了。请在下面使用相同的格式添加它们："""


BASELINE_PROMPT_3: str = """
## 药物安全性验证分析
### 当前推荐的候选药物
{init_drug_recommend}
### 药物详细描述信息库
{drug_detail}

### 患者特定信息
- 性别：{sex}
- 年龄：{years_old}
- 民族：{ethnicity}
- BMI：{bmi}
- 既往史：{past_history}
- 出院诊断：{discharge_diagnosis}

## 严格验证标准
对每个候选药物执行**强制安全性筛查**，出现以下任一情况立即剔除：
1. **禁忌症匹配**：药物禁忌症与患者当前诊断、基本情况或既往史明确冲突
2. **特殊人群禁忌**：药物不适合患者的年龄、性别、BMI等特定人群特征
3. **严重相互作用**：与患者现有疾病或必需药物存在严重相互作用风险

## 输出格式要求（必须严格遵守）
**只输出最终确认的药物列表**，严格按照以下格式：

("drug"{tuple_delimiter}"药物1"){record_delimiter}("drug"{tuple_delimiter}"药物2"){record_delimiter}("drug"{tuple_delimiter}"药物3")

### 重要格式规则：
1. 每个药物必须用括号包围
2. 每个药物格式为：("drug"{tuple_delimiter}"药物名称")
3. 药物之间用{record_delimiter}分隔
4. 列表末尾添加{completion_delimiter}
5. 不要添加任何其他文字、说明或编号

现在请输出最终确认的药物列表：
"""

BASELINE_PROMPT: dict = {
    "Chinese": {
        "TEMPLATE": BASELINE_TEMP,
        "CONTINUE": CONTINUE,
        "IF_LOOP": IF_LOOP,
    },
    "FIN_PROMPT": BASELINE_PROMPT_3,
    "FORMAT": {
        "tuple_delimiter": "<|>",
        "record_delimiter": "##",
        "completion_delimiter": "<|COMPLETE|>",
    },
}